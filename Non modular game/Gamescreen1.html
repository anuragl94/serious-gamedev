<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Police Quad Question Generator</title>
        <!-- Bootstrap -->
        <link href="../Public/css/bootstrap.min.css" rel="stylesheet" />
        <link href="css/gamedev.css" rel="stylesheet" />
        <script src="../Public/js/jquery-1.11.3.min.js"></script>
        <script src="../Public/js/bootstrap.min.js"></script>
        <script src="js/jquery-1.11.3.min.js"></script>
        <script src="../Engine/js/fetch.js"></script>
        <script>
            //Global gameData. Store all important attributes/module data here
            gameData = {
                'includedModules': []
            };

            $.getScript("options_renderer.js", function () {
                // Do what we must to render the options
                $("#optionsWrapper").append(returnValue['options_markup']);

                //~~These are the custom events for options
                $("#optionsWrapper").on("change", function () {
                    //Here we use statetracker module to capture the new state of the set of options
                    //It may be heavy on the processor if we check state of ALL options at every interaction with a single option
                });
                $("#optionsWrapper").on("disableSelected", function () {
                    $(this).find("input:checked").prop('disabled', true);
                    $(this).trigger("clearSelection");
                });
                $("#optionsWrapper").on("clearSelection", function () {
                    $(this).find("input:checked").prop('checked', false);
                });
                // This event listener comes from the tools section
                $("#optionsWrapper").on("inspect", function () {
                    //Here we get a list of selected options along with their attributes
                    var selectedOptions = $(this).find("input:checked").map(function () {
                        return $(this).attr("index");
                    });
                    $("#cluesWrapper").trigger("checkIfCorrectOptions", [selectedOptions]);
                });
                // This event listener comes from the tools section
                $("#optionsWrapper").on("arrest", function () {
                    //Here we get a list of selected options along with their attributes
                    var selectedOptions = $(this).find("input:checked").map(function () {
                        return $(this).attr("index");
                    });
                });

                //~~These are the custom events for clues
                $("#cluesWrapper").on("checkIfCorrectOptions", function (event, selectedOptions) {
                    //Here we get a list of selected options along with their attributes
                    var currentClueIndex = $("#cluesWrapper").find(".clue:visible").length - 1;
                    var currentClue = gameData['clues'][currentClueIndex];
                    var correctOptions = $(gameData['options']).map(function (index) {
                        var option = this;
                        switch (currentClue['comparator']) {
                            case '=':
                                if (option[currentClue['attribute']] === currentClue['quantity'])
                                    return index;
                                break;
                            case '>':
                                if (option[currentClue['attribute']] > currentClue['quantity'])
                                    return index;
                                break;
                            case '<':
                                if (option[currentClue['attribute']] < currentClue['quantity'])
                                    return index;
                                break;
                            default:
                                break;
                        }
                        return null;
                    });
                    correctOptions = $(correctOptions).filter(function (index) {
                        if (this !== null)
                            return true;
                    });
                    //To convert pseudo array to regular array
                    selectedOptions = Array.prototype.slice.call(selectedOptions);
                    correctOptions = Array.prototype.slice.call(correctOptions);

                    if (selectedOptions.sort().join(',') === correctOptions.sort().join(',')) {
                        //Success
                        console.log("Success! Good job!");
                        //$("#battery").trigger("refresh");
                        $("#cluesWrapper").trigger("getNextClue");
                        $("#optionsWrapper").trigger("disableSelected");
                        gameData['solvedClues'].push(currentClueIndex);
                    } else {
                        console.log("Investigation failed");
                        $("#battery").trigger("drain");
                        $("#cluesWrapper").find(".clue:visible").last().addClass("failure");
                    }
                });

                $("#cluesWrapper").on("getNextClue", function () {
                    $("#cluesWrapper").find(".clue:visible").last().removeClass("failure").addClass("success");
                    if ($("#cluesWrapper").find(".clue:not(:visible)").length) {
                        $("#cluesWrapper").find(".clue:not(:visible)").first().toggle();
                    } else {
                        console.log("You have sufficient clues to make an arrest!");
                    }
                });

                //~~These are the custom events for buttons
                //This is one pointless event. Need good advice
                $("#inspect").on('click', function () {
                    $("#optionsWrapper").trigger("inspect");
                });

                //~~These are the custom events for battery
                $("#battery").on("drain", function () {
                    var charge = parseInt($("#battery").attr("data-value")) - 1;
                    if (charge > 0) {
                        $("#battery").attr("data-value", charge);
                        $("#battery").attr("src", "battery" + charge.toString() + ".jpg");
                    } else {
                        console.log("Game over! Battery was drained!!");
                    }
                });
                $("#battery").on("charge", function () {
                    var charge = parseInt($("#battery").attr("data-value")) + 1;
                    if (charge <= $("#battery").attr("data-max")) {
                        $("#battery").attr("data-value", charge);
                        $("#battery").attr("src", "battery" + charge.toString() + ".jpg");
                    } else {
                        console.log("You're overcharging the battery!");
                    }
                });
                $("#battery").on("refresh", function () {
                    var charge = $("#battery").attr("data-max");
                    $("#battery").attr("data-value", charge);
                    $("#battery").attr("src", "battery" + charge.toString() + ".jpg");
                });

                // The following lines render HTML markup for the clues. The code will be pushed into the relevant module
                var cluesBox = document.createElement("div");
                $(cluesBox).attr("id", "clues");
                $(returnValue['clues']).each(function () {
                    //This next line must go through the language API for translation. Not translating into any language for now
                    var clue_text = "Culprit has " + this['attribute'] + this['comparator'] + this['quantity'] + "<br />";
                    var property = "Culprit has " + this['attribute'] + this['comparator'] + this['quantity'] + "<br />";
                    var clue = '<div class="clue" data-attr="' + property + '">' + clue_text + '</div>';
                    $(cluesBox).append(clue);
                });
                $("#cluesWrapper").append(cluesBox);
                $("#cluesWrapper").find(".clue:not(:first-child)").each(function () {
                    $(this).toggle();
                });
                gameData['solvedClues'] = [];
            });
        </script>
        <style>
            .option
            {
                height: 220px;
                border:solid 1px #eeeeee;
            }

            .moduleWrapper {
                border:solid 1px #dddddd;
            }
        </style>
    </head>
    <body>
        <div class="navbar" style="color:white;background-color:rgba(31, 137, 224, 1);">
            <h1>Police Quad</h1>
        </div>
        <h3 style="padding-left:4em;">
            One of the shapes is the culprit.<br>
            Click on the innocent shapes to ELIMINATE them.<br>
            The last one left is the culprit â€“ ARREST IT!
        </h3>
        <div class="row">
            <div class="col-md-9 moduleWrapper" id="optionsWrapper">
            </div>
            <div class="col-md-3">
                <h2>Clues</h2>
                <div class="moduleWrapper" id="cluesWrapper">
                </div>
                <h2>Tools</h2>
                <!--Insert tools here-->
                <button id="inspect">
                    <img src="inspect.jpg" height=70 />
                </button>
                <button id="arrest">
                    <img src="makeArrest.gif" height=70 />
                </button>
                <img id="battery" src="battery4.jpg" data-value="4" data-max="4" />
            </div>
        </div>
    </body>
</html>
